<!-- Header avec boutons d'action -->
<div class="d-flex justify-content-between mb-5 flex-wrap gap-2">
  
  <!-- Bouton Créer un rendez-vous -->
  <div *ngIf="(myPrestation.need_meeting && selected_data?.status==5) || (myPrestation.need_meeting && !myPrestation.from_pns)">
    <button type="button" class="btn btn-dark text-white">
      <i class="bi bi-calendar me-2"></i>
      Créer un rendez-vous
    </button>
  </div>

  <!-- Bouton Affecter -->
  <div>
    <button 
      class="btn btn-primary" 
      data-bs-toggle="tooltip" 
      data-bs-placement="top" 
      title="Affecter cette demande"
      *ngIf="hasPermission('affectation') && (!isTreated || !isMyTreated) && selected_data?.status!=7 && uas.length!=0 && selected_data?.status!=6" 
      (click)="open('dialogAffectation')">
      <i class="bi bi-arrow-down-right me-2"></i>
      {{isTreated && !isMyTreated ? 'Retourner pour correction':'Affecter'}}
    </button>
  </div>

  <!-- Bouton Traiter la demande -->
  <div>
    <button 
      class="btn btn-warning" 
      data-bs-toggle="tooltip" 
      data-bs-placement="top" 
      title="Traiter la demande"
      *ngIf="hasPermission('modification') && !isTreated && selected_data?.status!=7" 
      (click)="open2()">
      <i class="bi bi-pencil me-2"></i>
      Traiter la demande
    </button>
  </div>

  <!-- Bouton Modifier/Voir réponse -->
  <div>
    <button 
      class="btn btn-warning" 
      data-bs-toggle="tooltip" 
      data-bs-placement="top" 
      title="Editer un projet de réponse"
      *ngIf="selected_data?.status!=7 && selected_data?.status!=4 && hasPermission('modification') && isTreated" 
      (click)="open2()">
      <i class="bi bi-pencil me-2"></i>
      {{isMyTreated ? 'Modifier mon avis':'Voir la réponse du collaborateur'}}
    </button>
  </div>

  <!-- Bouton Transmettre -->
  <div>
    <button 
      class="btn btn-success" 
      data-bs-toggle="tooltip" 
      data-bs-placement="top" 
      title="Transmettre au supérieur"
      *ngIf="selected_data?.status!=7 && isMyTreated && !isSigner() && selected_data?.status !=9" 
      (click)="transUp()">
      <i class="bi bi-arrow-up-right me-2"></i>
      Transmettre au supérieur
    </button>
  </div>

  <!-- Bouton Valider -->
  <div>
    <button 
      class="btn btn-success" 
      data-bs-toggle="tooltip" 
      data-bs-placement="top" 
      title="Valider réponse"
      *ngIf="isTreated && myPrestation.need_validation && responseUA?.hasPermission && selected_data?.status!=5" 
      (click)="validate()">
      <i class="bi bi-arrow-up-right me-2"></i>
      Valider provisoirement
    </button>
  </div>

  <!-- Bouton Suspendre pour accord -->
  <div>
    <button 
      class="btn btn-info" 
      data-bs-toggle="tooltip" 
      data-bs-placement="top" 
      title="Suspendre pour accord à l'amiable"
      *ngIf="hasPermission('suspension') && prestation=='autorisation-de-licenciement-pour-motif-economique-ou-motif-personnel' && selected_data?.status!=7" 
      (click)="sendReachedAgreement()">
      <i class="bi bi-info-circle me-2"></i>
      Suspendre pour accord
    </button>
  </div>
</div>

<!-- Contenu principal -->
<div class="card card-body">
  <div class="h3 mb-4">Détails de la demande</div>

  <!-- Alerte d'instruction -->
  <div *ngIf="selected_data?.affectation?.instruction!=null" class="alert alert-info border-start border-info border-4">
    <div class="d-flex align-items-start">
      <i class="bi bi-info-circle me-3 mt-1"></i>
      <div>
        <p class="mb-2"><strong>Instruction :</strong> {{selected_data?.affectation?.instruction}}</p>
        <p class="mb-0"><strong>Pour au plus tard, le</strong> {{ selected_data.affectation?.delay}}</p>
      </div>
    </div>
  </div>

  <!-- Informations de la demande -->
  <fieldset class="mb-4" *ngFor="let sc of stepContents">
    <legend class="bg-info p-2 text-white rounded mb-3">
      <i class="bi bi-building me-2"></i>
      {{sc.title}}
    </legend>
    <div class="row g-4">
      <div class="col-md-4" *ngFor="let line of sc.content |keyvalue">
        <div class="info-item">
          <dt class="dt fw-semibold text-muted mb-1">
            <i class="bi bi-building me-2"></i>
            {{line.key}}
          </dt>
          <dd class="dd text-dark">{{line.value}}</dd>
        </div>
      </div>
    </div>
  </fieldset>



  <!-- Pièces jointes -->
  <fieldset class="mb-4">
    <legend class="bg-info p-2 text-white rounded mb-3">
      <i class="bi bi-paperclip me-2"></i>
      Pièces jointes
    </legend>
    <div class="row g-3">
      <div *ngFor="let f of selected_data.files" class="col-md-3">
        <div class="card h-100 border">
          <div class="card-body p-3">
            <dt class="dt fw-semibold text-muted mb-2">
              <i class="bi bi-file-earmark-text me-2"></i>
              {{f.filename}}
            </dt>
            <dd class="dd">
              <button class="btn btn-sm btn-dark" (click)="showFile(f)">
                <i class="bi bi-eye me-1"></i>
                Voir fichier
              </button>
            </dd>
          </div>
        </div>
      </div>
    </div>
  </fieldset>

  <!-- Historique des avis -->
  <!-- <fieldset>
    <legend class="bg-info p-2 text-white rounded mb-3">
      <i class="bi bi-clock-history me-2"></i>
      Historique des avis
    </legend>
    <div class="row g-3">
      <div *ngFor="let r of selected_data.reponses" class="col-12">
        <div class="card border shadow-sm">
          <div class="card-body p-4">
            <div class="d-flex align-items-center mb-3">
              <span class="badge me-3 fs-6" [ngClass]="getDecisionClass(r.hasPermission)">
                {{getDecisionIcon(r.hasPermission)}}
              </span>
              <h5 class="text-primary mb-0">{{r.unite_admin.libelle}}</h5>
            </div>
            
            <div class="mb-3">
              <h6 class="mb-2">
                <strong class="text-secondary me-1">Accord :</strong>
                <span [ngClass]="getDecisionClass(r.hasPermission)">
                  {{getDecision(r.hasPermission)}}
                </span>
              </h6>
              
              <div class="mb-3">
                <strong class="text-secondary me-1">Argumentaire :</strong>
                <p class="mb-0 mt-1">{{r.reason}}</p>
              </div>
              
              <div class="mb-3">
                <strong class="text-secondary me-1">Observation :</strong>
                <p class="mb-0 mt-1">{{r.observation}}</p>
              </div>
            </div>

            <div class="d-flex gap-2 flex-wrap">
              <button 
                *ngIf="r.note != null" 
                class="btn btn-primary btn-sm" 
                (click)="showResponseFile(r.note!)">
                <i class="bi bi-file-earmark-text me-1"></i>
                Voir la note de service
              </button>
              <button 
                *ngIf="r.preview_file != null" 
                class="btn btn-primary btn-sm" 
                (click)="showResponseFile(r.preview_file!)">
                <i class="bi bi-file-earmark-text me-1"></i>
                Voir le prototype livrable
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </fieldset> -->
</div>
<ng-container *ngIf="selected_data!=undefined">
    <div *ngIf="!showPreview2 && !showPreview">

    </div>
</ng-container>
<div class="text-center"  *ngIf="selected_data==undefined">
    <img src="assets/spinner.gif" alt="" height="50">
</div>

<ng-template #dialogAffectation let-c="close" let-d="dismiss">
    <form #addInstruction="ngForm" (ngSubmit)="transDown(addInstruction.value)">
    <div class="modal-header">
      <h4 class="modal-title" id="modal-basic-title"> {{isTreated && !isMyTreated ? 'Retour pour correction':'Affecter la demande'}} </h4>
      <button type="button" class="btn btn-dark"  (click)="d('Cross click')"> <i class="fa fa-times"></i></button>
    </div>
    <div class="modal-body">
        <div>
            <div class="form-group">
                <label for="">Choisir un collaborateur</label>
                <select name="ua_down_id" id="" class="form-control" ngModel required >
                    <option *ngFor="let ua of uas" [value]="ua.id">{{ua.libelle}}</option>
                </select>
            </div>
            <div class="form-group">
                <label for="">Laissez une instruction</label>
                <textarea name="instruction" rows="3" class="form-control" required ngModel maxlength="200"></textarea>
            </div>
            <div class="form-group">
                <label for="">Pour au plus tard, le </label>
                <input type="date" nbInput name="delay" required ngModel class="form-control">
            </div>
        </div>    </div>
    <div class="modal-footer">
        <button type="submit" class="btn btn-primary" [disabled]="addInstruction.invalid || loading">Sauvegarder <app-loading [isVisible]="loading"></app-loading> </button>
    </div>
</form>

  </ng-template>


<div *ngIf="showPreview"  class="container">
    <div>
        <div>
            <div class="d-flex justify-content-around">
                <button class="btn btn-dark mb-3 " (click)="back()">Fermer le visualiseur</button>
                <!--button  *ngIf="!showResponseFilePreview"  class="btn btn-success mb-3 " [disabled]="!activeobsPanel"  (click)="openWindow(contentTemplateAmendement)">Faire des observations</!--button-->
        
            </div>
        </div>

        <div>
         
            <object [data]="pdfSrc" type="application/pdf" width="100%" height="600px"></object>
        </div>
    </div>
  
    
  </div>



  <ng-template #contentTemplateAmendement let-c="close" let-d="dismiss">
    <form #addAmend="ngForm" (ngSubmit)="storeAmend()">

    <div class="modal-header">
      <h4 class="modal-title" id="modal-basic-title">Observation sur pièce analysée</h4>
      <button type="button" class="btn btn-dark"  (click)="d('Cross click')"> <i class="fa fa-times"></i></button>
    </div>
    <div class="modal-body">
        <div class="form-group">
            <label for="">observation</label>
            <textarea name="" id="" cols="30" class="form-control" rows="5" [(ngModel)]="observation" name="observation"
            ></textarea>
        </div>
        </div>
    <div class="modal-footer">
        <button type="submit" class="btn btn-primary" [disabled]="addAmend.invalid || loading">Sauvegarder <app-loading [isVisible]="loading"></app-loading> </button>
    </div>
    </form>

 </ng-template>


<ng-template #dialogRejet let-c="close" let-d="dismiss">
    <form #addRejet="ngForm" (ngSubmit)="decline(addRejet.value)">

    <div class="modal-header">
      <h4 class="modal-title" id="modal-basic-title">Rejet de la demande</h4>
      <button type="button" class="btn btn-dark"  (click)="d('Cross click')"> <i class="fa fa-times"></i></button>
    </div>
    <div class="modal-body">
        <div class="form-group">
            <label for="">Laissez le motif</label>
            <textarea name="commentaire" rows="3" class="form-control" required ngModel></textarea>
        </div>    </div>
    <div class="modal-footer">
        <button type="submit" class="btn btn-primary" [disabled]="addRejet.invalid || loading">Sauvegarder <app-loading [isVisible]="loading"></app-loading> </button>
    </div>
</form>

  </ng-template>    


<ng-template #dialogSuspension let-c="close" let-d="dismiss">
    <form #addSusp="ngForm" (ngSubmit)="needCorrection(addSusp.value)">

    <div class="modal-header">
      <h4 class="modal-title" id="modal-basic-title">Suspension de la demande</h4>
      <button type="button" class="btn btn-dark"  (click)="d('Cross click')"> <i class="fa fa-times"></i></button>
    </div>
    <div class="modal-body">
        <div class="form-group">
            <label for="">Laissez le motif</label>
            <textarea name="commentaire" rows="3" class="form-control" required ngModel></textarea>
        </div>
    </div>
    <div class="modal-footer">
        <button type="submit" class="btn btn-primary" [disabled]="addSusp.invalid || loading">Sauvegarder <app-loading [isVisible]="loading"></app-loading> </button>
    </div>
</form>

  </ng-template>


  
<div *ngIf="showPreview2"  class="container">
    <div>
        <div>
            <div class="d-flex justify-content-around">
                <button class="btn btn-dark mb-3 " (click)="back3()">Fermer le visualiseur</button>
             
                <button class="btn btn-success mb-3 " *ngIf="hasPermission('autorisation') && !selected_data?.isAutorized && isSigner() && selected_data?.status!=7"  [disabled]="loading" (click)="open(dialogSign)">Signer l'attestation / Délivrer mon visa</button>
                <button class="btn btn-success mb-3 " *ngIf="hasPermission('autorisation') && selected_data?.isAutorized && isSigner() && selected_data?.status!=7"  [disabled]="loading" (click)="delivered()">Délivrer l'attestation / Délivrer le document final</button>
        
            </div>
        </div>

        <div>
         
            <object [data]="pdfSrc" type="application/pdf" width="100%" height="600px"></object>
        </div>
    </div>
  
    
  </div>


  <ng-template #dialogSign  let-c="close" let-d="dismiss">
    <form #addInstruction="ngForm" (ngSubmit)="authorized(addInstruction.value)">

        <div class="modal-header">
            <h4 class="modal-title" id="modal-basic-title">Signer ce document</h4>
            <button type="button" class="btn btn-dark"  (click)="d('Cross click')"> <i class="fa fa-times"></i></button>
        </div>
      <div class="modal-body">
            <div class="form-group">
                <label for="">Saisissez votre mot de passe de délivrance</label>
                <input name="password" type="password" class="form-control" required ngModel>
            </div>
        </div>
    <div class="modal-footer">
        <button type="submit" class="btn btn-primary" [disabled]="addInstruction.invalid || loading">Signer <app-loading [isVisible]="loading"></app-loading> </button>
    </div>

</form>

</ng-template>