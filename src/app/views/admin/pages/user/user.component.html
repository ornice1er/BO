
<h2 class="text-center mb-4 page-subtitle">Liste des utilisateurs</h2>

<div class="row">
<div class="col-lg-12">
    <div class="card custom-card">
    <!-- Card Header with Actions -->
    <div class="card-header-actions">
        <div class="d-flex justify-content-between align-items-center">
        <button class="btn btn-primary-custom" (click)="add(addContent)">
            <i class="bi bi-plus-lg me-2"></i>
            Ajouter
        </button>
        
        <div class="search-controls d-flex align-items-center">
            <div class="input-group">
            <select class="form-select filter-select" [(ngModel)]="selectedFilter">
                <option value="">Filtrer Par</option>
                <option value="role">Rôle</option>
                <option value="status">Statut</option>
            </select>
            <input 
                type="text" 
                class="form-control search-input" 
                name="search_text" 
                [(ngModel)]="search_text"   
                (ngModelChange)="onSearchChange()" 
                placeholder="Rechercher...">
            <button (click)="resetSearch()" class="btn btn-outline-primary reset-btn" type="button">
                <i class="fa fa-rotate-left"></i>
            </button>
            </div>
        </div>
        </div>
    </div>

    <div class="card-body">
        <div class="results-info mb-3">
        <p class="text-muted mb-0">
            <i class="bi bi-list-ul me-2"></i>
            {{data.length}} élément(s)
        </p>
        </div>

        <div class="table-responsive">
        <table class="table custom-table">
            <thead>
            <tr>
                <th style="width: 50px;">#</th>
                <th>Identité</th>
                <th>Email</th>
                <th>Rôle</th>
                <th>Statut</th>
            </tr>
            </thead>
            <tbody>
            <tr *ngFor="let d of data | paginate: {
                                    id:'ngxP1',
                                    itemsPerPage: pg.pageSize,
                                    currentPage: pg.p,
                                    totalItems: pg.total } | sampleSearch:search_text" class="table-row">
                <td class="position-relative checkbox-cell">
                <div class="form-check">
                    <input
                    (click)="checked(d)"
                    class="form-check-input custom-radio"
                    type="radio"
                    name="selectedDoc"
                    [value]="d.id"
                    [(ngModel)]="selectedId"
                    id="radio-{{ d.id }}"
                    />
                </div>

                <div *ngIf="selectedId === d.id" class="overlay-panel-right">
                    <div class="overlay-actions-grid">
                    <button
                        class="btn btn-action btn-add"
                        (click)="add(addContent)"
                        title="Ajouter"
                    >
                        <i class="bi bi-plus-lg"></i>
                    </button>

                    <button
                        (click)="show(showContent)"
                        type="button"
                        class="btn btn-action btn-view"
                        title="Consulter"
                    >
                        <i class="bi bi-eye"></i>
                    </button>

                    <button
                        (click)="edit(editContent)"
                        type="button"
                        class="btn btn-action btn-edit"
                        title="Éditer"
                    >
                        <i class="bi bi-pencil"></i>
                    </button>

                    <button
                        (click)="delete()"
                        type="button"
                        class="btn btn-action btn-delete"
                        title="Supprimer"
                    >
                        <i class="bi bi-trash"></i>
                    </button>

                    <button
                        *ngIf="!d.is_active"
                        (click)="setStatus(1)"
                        type="button"
                        class="btn btn-action btn-activate"
                        title="Activer"
                    >
                        <i class="bi bi-toggle-on"></i>
                    </button>

                    <button
                        *ngIf="d.is_active"
                        (click)="setStatus(0)"
                        type="button"
                        class="btn btn-action btn-deactivate"
                        title="Désactiver"
                    >
                        <i class="bi bi-toggle-off"></i>
                    </button>

                    <button
                        (click)="resetPassword(resetContent)"
                        type="button"
                        class="btn btn-action btn-reset"
                        title="Réinitialiser le mot de passe"
                    >
                        <i class="bi bi-arrow-counterclockwise"></i>
                    </button>

                    <button
                        type="button"
                        class="btn btn-action btn-close-panel"
                        (click)="selectedId = null"
                        title="Fermer"
                    >
                        <i class="bi bi-x-lg"></i>
                    </button>
                    </div>
                </div>
                </td>

                <td>
                <div class="user-info">
                    <div class="user-avatar">
                    {{ getInitials(d.agent?.lastname || 'U', d.agent?.firstname || '') }}
                    </div>
                    <div class="user-details">
                    <div class="user-name">
                        {{ d.agent?.lastname || 'Non défini' }} {{ d.agent?.firstname }}
                    </div>
                    <small class="user-id text-muted">ID: {{ d.id }}</small>
                    </div>
                </div>
                </td>

                <td>
                <span class="email-text">{{ d.email }}</span>
                </td>

                <td>
                <div class="roles-list">
                    <span *ngFor="let r of d.roles; let last = last" class="role-badge">
                    {{ r.name }}<span *ngIf="!last">, </span>
                    </span>
                </div>
                </td>

                <td>
                <span [class]="'status-badge ' + (d.is_active ? 'badge-active' : 'badge-inactive')">
                    {{ d.is_active ? 'Actif' : 'Bloqué' }}
                </span>
                </td>
            </tr>

            <tr *ngIf="search_text !== '' && data.length === 0" class="no-results-row">
                <td colspan="5" class="text-center py-4">
                <div class="no-results">
                    <i class="bi bi-search mb-3"></i>
                    <p class="text-muted mb-3">Recherche avancée en cours...</p>
                    <button class="btn btn-outline-secondary btn-sm" (click)="resetSearch()">
                    <i class="bi bi-arrow-counterclockwise me-2"></i>
                    Réinitialiser la recherche
                    </button>
                </div>
                </td>
            </tr>
            </tbody>
        </table>
        </div>

        <!-- Pagination placeholder -->
        <div class="pagination-container mt-4">
        
        <pagination-controls 
                        id="ngxP1"
                        (pageChange)="getPage($event)"
                        [maxSize]="9"
                        [directionLinks]="true"
                        [autoHide]="true"
                        [responsive]="true"
                        [previousLabel]="'Précédent'"
                        [nextLabel]="'Suivant'"
                        [screenReaderPaginationLabel]="'Pagination'"
                        [screenReaderPageLabel]="'page'"
                        [screenReaderCurrentLabel]="'Vous êtes sur la page'">
                    </pagination-controls>
        </div>
    </div>
    </div>
</div>
</div>


<ng-template #addContent let-modal>
    <form #addForm="ngForm" (ngSubmit)="store(addForm.value)">
    <div class="modal-header">
      <h6 class="modal-title" id="modal-basic-title">Enregistrer un  compte utilisateur</h6>
		<button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss('Cross click')"></button>
    </div>
    <div class="modal-body" >
        <div class="row mb-3" >
            
            <div class=" form-group col-12 mb-3">
                <label for="">Email <span class="text-danger ml-2">(*)</span></label>
                <input type="text" name="email" class="form-control" ngModel>
            </div>
            <div class=" form-group col-12 mb-3">
                <label for="">Contact <span class="text-danger ml-2">(*)</span></label>
                <input type="text" name="phone" class="form-control" ngModel>
            </div>
                <div class="form-group" *ngIf="role!='Admin national'">
                <label for="typeLabel">Agent</label>
                <ng-select type="text" class="form-control" id="typeLabel" aria-describedby="typeLabelHelp" required #type="ngModel" name="agent_id" ngModel>
                    <ng-option [value]="t?.id" *ngFor="let t of data2">{{t?.lastname}} {{t?.firstname}}</ng-option>
                </ng-select>
            </div>
            <div class=" form-group col-12 mb-3">
                <label for="">Rôle <span class="text-danger ml-2">(*)</span></label>
                <ng-select name="roles" ngModel [multiple]="true">
                    <ng-option *ngFor="let s of roles" [value]="s.name">{{s.name}}</ng-option>
                </ng-select>
            </div>

              <div class="d-flex justify-content-between">
          <p>Acteur métier :</p>
          <ng-toggle
          ngModel

          name="is_trade"
          [color]="{
              unchecked: '#939da2',
              checked: '#0C574E'
          }"
          [values]="{
              checked: true, unchecked: false
          }"
  
          ></ng-toggle>
        </div>
        <div class="" *ngIf="role != 'Admin national'">
          <h4>Affectation des prestations au compte utilisateur</h4>
          <h6>Ce compte aura accès aux prestations suivantes</h6>
          <div class="container">
            <div class="row">
              <div class="col-6 form-check" *ngFor="let p of prestations, let i=index">
                <input class="form-check-input" type="checkbox" name="state"  [(ngModel)]="p.state" >
                <label class="form-check-label">
                  {{p.name}}
                </label>
              </div>
            </div>
          </div>
          
        </div>
        </div>
       
    </div>
    <div class="modal-footer">
      <button type="submit" class="btn btn-outline-dark" [disabled]="addForm.invalid || loading"  >Créer le compte <app-loading [isVisible]="loading"></app-loading></button>
    </div>
</form>
  </ng-template>

  <ng-template #editContent let-modal>
    <form #editForm="ngForm" (ngSubmit)="update(editForm.value)">
    <div class="modal-header">
      <h6 class="modal-title" id="modal-basic-title">Modifier un utilisateur</h6>
		<button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss('Cross click')"></button>
    </div>
    <div class="modal-body" >
        <div class="row mb-3">
          
            <div class=" form-group col-12 mb-3">
                <label for="">Email <span class="text-danger ml-2">(*)</span></label>
                <input type="text" name="email" class="form-control" [(ngModel)]="selected_data.email">
            </div>
            <div class=" form-group col-12 mb-3">
                <label for="">Contact <span class="text-danger ml-2">(*)</span></label>
                <input type="text" name="phone" class="form-control" [(ngModel)]="selected_data.phone">
            </div>
            <div class="form-group" *ngIf="role!='Admin national'">
                <label for="typeLabel">Agent</label>
                <ng-select type="text" class="form-control" id="typeLabel" aria-describedby="typeLabelHelp" required #type="ngModel" name="agent_id" [(ngModel)]="selected_data.agent_id">
                    <ng-option [value]="t?.id" *ngFor="let t of data2">{{t?.lastname}} {{t?.firstname}}</ng-option>
                </ng-select>
            </div>
            <div class=" form-group col-12 mb-3">
                <label for="">rôle <span class="text-danger ml-2">(*)</span></label>
                <ng-select name="roles" [multiple]="true" [(ngModel)]="selectedRoles">
                    <ng-option *ngFor="let s of roles" [value]="s.name">{{s.name}}</ng-option>
                </ng-select>  
             </div>


        <div class="d-flex justify-content-between">
          <p>Acteur métier :</p>
          <ng-toggle
          ngModel

          name="is_trade"
          [color]="{
              unchecked: '#939da2',
              checked: '#0C574E'
          }"
          [values]="{
              checked: true, unchecked: false
          }"
  
          ></ng-toggle>
        </div>
        <div class="" *ngIf="role != 'Admin national'">
          <h4>Affectation des prestations au compte utilisateur</h4>
          <h6>Ce compte aura accès aux prestations suivantes</h6>
          <div class="container">
            <div class="row">
              <div class="col-6 form-check" *ngFor="let p of prestations, let i=index">
                <input class="form-check-input" type="checkbox" name="state"  [(ngModel)]="p.state" >
                <label class="form-check-label">
                  {{p.name}}
                </label>
              </div>
            </div>
          </div>
          
        </div>

           
        </div>
       
    </div>
    <div class="modal-footer">
      <button type="submit" class="btn btn-outline-dark" [disabled]="editForm.invalid || loading" >Sauvegarder <app-loading [isVisible]="loading"></app-loading></button>
    </div>
</form>
  </ng-template>
  <ng-template #resetContent let-modal>
    <form #editForm="ngForm" (ngSubmit)="resetPassword(editForm.value)">
    <div class="modal-header">
      <h6 class="modal-title" id="modal-basic-title">Réinitialiser le mot de passe </h6>
		<button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss('Cross click')"></button>
    </div>
    <div class="modal-body" >
        <div class="row mb-3">
        
            <div class=" form-group col-12 mb-3">
                <label for="">Email <span class="text-danger ml-2">(*)</span></label>
                <input type="text" name="email" class="form-control" [(ngModel)]="selected_data.email">
            </div> 
            <div class=" form-group col-12 mb-3">
                <label for="">Mot de passe <span class="text-danger ml-2">(*)</span></label>
                <input type="password" name="password" class="form-control" minlength="8" ngModel>
            </div> 
            <div class=" form-group col-12 mb-3">
                <label for="">Confirmer le mot de passe <span class="text-danger ml-2">(*)</span></label>
                <input type="password" name="password_confirmation" class="form-control" minlength="8" ngModel>
            </div> 
           
          
             <div class="d-flex justify-content-between">
          <p>Acteur métier :</p>
          <ng-toggle
          [(ngModel)]="selected_data.is_trade"
          name="is_trade"
          [color]="{
              unchecked: '#939da2',
              checked: '#0C574E'
          }"
          [values]="{
              checked: true, unchecked: false
          }"
          ></ng-toggle>
        </div>
        <div class="" *ngIf="role != 'Admin national'">
          <h4>Affectation des prestations au compte utilisateur</h4>

          <h6>Ce compte aura accès aux prestations suivantes</h6>

        <div class="container">
          <div class="row">
            <div class="col-6 form-check" *ngFor="let p of prestations, let i=index">
              <input class="form-check-input" type="checkbox" [checked]="p.state" name="state{{i}}"  [(ngModel)]="p.state" >
              <label class="form-check-label">
                {{p.name}}
              </label>
            </div>
          </div>
        </div>
        
        </div>
        </div>
       
    </div>
    <div class="modal-footer">
      <button type="submit" class="btn btn-outline-dark" [disabled]="editForm.invalid || loading" >Réinitialiser <app-loading [isVisible]="loading"></app-loading></button>
    </div>
</form>
  </ng-template>

  <ng-template #showContent let-modal>
    <div class="modal-header">
        <h4 class="modal-title" id="modal-basic-title">Détails des informations</h4>
		<button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss('Cross click')"></button>
      </div>

      <div class="modal-body">
        <div class="table-responsive table-card">
            <table class="table table-borderless align-middle mb-0">
                <tbody>
                  
               
                    <tr >
                        <td class="fw-medium">Nom</td>
                        <td >{{selected_data.lastname}} </td>
                      
                    </tr>
                    <tr >
                        <td class="fw-medium">Prénoms</td>
                        <td >{{selected_data.firstname}} </td>
                      
                    </tr>
                    <tr >
                        <td class="fw-medium">Email</td>
                        <td >{{selected_data.email}} </td>
                      
                    </tr>
                    <tr >
                        <td class="fw-medium">Contact</td>
                        <td >{{selected_data.phone}} </td>
                      
                    </tr>
                    <tr >
                        <td class="fw-medium">Date de naissance</td>
                        <td >{{selected_data.birthdate | date:"dd-MM-yyyy"}} </td>
                      
                    </tr>
                    <tr >
                        <td class="fw-medium">Lieu de naissance</td>
                        <td >{{selected_data.birthplace}} </td>
                      
                    </tr>
               
                    <tr >
                        <td class="fw-medium">rôle</td>
                        <td >{{selected_data.roles[0].name}} </td>
                      
                    </tr>
               
                </tbody>
            </table>
        </div>
      </div>
</ng-template>